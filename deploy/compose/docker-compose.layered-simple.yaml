version: "3.9"

services:
  # Node 1: Layered Application (3 layers in 1 container)
  layered-app:
    build:
      context: ../..
      dockerfile: deploy/docker/layered_simple/Dockerfile.app
    container_name: urlshort-layered-app
    environment:
      - REDIS_URL=redis://redis-master:6379/0
      - GATEWAY_BASE_URL=http://localhost:8081
      - GRPC_PORT=50051
      - RL_LIMIT_PER_MIN=120
      - RL_WINDOW_SEC=60
    depends_on:
      - redis-master
    networks:
      - layered-net

  # Node 2: Nginx (HTTP/2 reverse proxy)
  nginx:
    image: nginx:alpine
    container_name: urlshort-nginx
    ports:
      - "8081:8081"
    volumes:
      - ../nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - layered-app
    networks:
      - layered-net

  # Node 3: Redis Master (primary storage)
  redis-master:
    image: redis:7-alpine
    container_name: urlshort-redis-master
    command: redis-server --appendonly yes
    volumes:
      - redis-master-data:/data
    networks:
      - layered-net

  # Node 4: Redis Replica (read replica)
  redis-replica:
    image: redis:7-alpine
    container_name: urlshort-redis-replica
    command: redis-server --replicaof redis-master 6379 --replica-read-only yes
    depends_on:
      - redis-master
    volumes:
      - redis-replica-data:/data
    networks:
      - layered-net

  # Node 5: Analytics Worker (background processor)
  analytics-worker:
    build:
      context: ../..
      dockerfile: deploy/docker/layered_simple/Dockerfile.worker
    container_name: urlshort-analytics-worker
    environment:
      - REDIS_URL=redis://redis-master:6379/0
      - WORKER_INTERVAL=10
    depends_on:
      - redis-master
    networks:
      - layered-net

volumes:
  redis-master-data:
  redis-replica-data:

networks:
  layered-net:
    name: urlshortener-layered-simple
